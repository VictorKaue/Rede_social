const db = require('../config/connection');

async function getTodosPosts(req, res) {
    try {
        const [linhas] = await db.query('SELECT * FROM post');
        res.json(linhas);
    } catch (erro){
        res.status(500).json({ erro: 'Erro ao buscar posts'});
    }
}

async function getPostPeloId(req, res) {
    const id = req.params.id;
    try {
        const [linhas] = await db.query('SELECT * FROM post WHERE id = ?', [id]);
        if (linhas.length === 0) {
            return res.status(404).json({ mensagem: 'Post não encontrado' });
        }
        res.json(linhas[0]);
    } catch (erro) {
        res.status(500).json({ erro: 'Erro ao buscar post' });
    }
}

async function atualizarPost(req, res) {
    const id = req.params.id;
    const { titulo, conteudo, data_publicacao, autor_id } = req.body;
    try {
        const [resultado] = await db.query(
            'UPDATE post SET titulo = ?, conteudo = ?, data_publicacao = ?, autor_id = ? WHERE id = ?',
            [titulo, conteudo, data_publicacao, autor_id, id]
        );
        if (resultado.affectedRows === 0) {
            return res.status(404).json({ mensagem: 'Post não encontrado' });
        }
        res.json({ mensagem: 'Post atualizado com sucesso' });
    } catch (erro) {
        res.status(500).json({ erro: 'Erro ao atualizar post' });
    }
}

async function cadastrarPost(req, res) {
    const { titulo, conteudo, data_publicacao, autor_id } = req.body;
    try {
        const [resultado] = await db.query(
            'INSERT INTO post (titulo, conteudo, data_publicacao, autor_id) VALUES (?, ?, ?, ?)',
            [titulo, conteudo, data_publicacao, autor_id]
        );
        res.status(201).json({ id: resultado.insertId, mensagem: 'Post criado com sucesso' });
    } catch (erro) {
        res.status(500).json({ erro: 'Erro ao criar post' });
    }
}

async function deletarPost(req, res) {
    const id = req.params.id;
    try {
        const [resultado] = await db.query('DELETE FROM post WHERE id = ?', [id]);
        if (resultado.affectedRows === 0) {
            return res.status(404).json({ mensagem: 'Post não encontrado' });
        }
        res.json({ mensagem: 'Post deletado com sucesso' });
    } catch (erro) {
        res.status(500).json({ erro: 'Erro ao deletar post' });
    }
}

module.exports = {
    getTodosPosts,
    getPostPeloId,
    atualizarPost,
    cadastrarPost,
    deletarPost
};

